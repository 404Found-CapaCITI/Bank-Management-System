<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Endless Vault Dashboard</title>
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
  <div class="header">
    <div class="dashboard-title">
      <span>Endless </span>
      <span class="vault-name">Vault</span>
    </div>

    <div class="profile-section" id="profileSection">
      <div class="profile-icon">
        <img src="/images/logo.png" alt="Profile Logo" />
    </div>    
      <div class="profile-name" id="userName">Loading...</div>
      <div class="profile-dropdown" id="profileDropdown">
        <div class="dropdown-item">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
          </svg>
          My Profile
        </div>
        <div class="dropdown-item">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
          </svg>
          Account Settings
        </div>
        <div class="dropdown-divider"></div>
        <div class="dropdown-item">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z" />
          </svg>
          Help Center
        </div>
        <div class="dropdown-divider"></div>
        <div class="dropdown-item" id="logoutBtn">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z" />
          </svg>
          Log Out
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="dashboard-container">
      <div class="balance-section">
        <h2 class="balance-title">Current Balance</h2>
        <div class="balance-amount" id="balanceAmount">R0.00</div>

        <div class="actions-grid">
          <div class="action-card deposit" id="depositBtn">
            <div class="action-icon deposit">
              <svg class="icon" viewBox="0 0 24 24" fill="white">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
              </svg>
            </div>
            <h3 class="action-title">Deposit</h3>
            <p class="action-description">Add funds to your account</p>
          </div>

          <div class="action-card withdraw" id="withdrawBtn">
            <div class="action-icon withdraw">
              <svg class="icon" viewBox="0 0 24 24" fill="white">
                <path d="M19 13H5v-2h14v2z" />
              </svg>
            </div>
            <h3 class="action-title">Withdraw</h3>
            <p class="action-description">Withdraw funds from your account</p>
          </div>

          <div class="action-card create" id="createAccountBtn">
            <div class="action-icon create">
              <svg class="icon" viewBox="0 0 24 24" fill="white">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z" />
              </svg>
            </div>
            <h3 class="action-title">New Account</h3>
            <p class="action-description">Open a new bank account</p>
          </div>

          <div class="action-card transfer" id="transferBtn">
            <div class="action-icon transfer">
              <svg class="icon" viewBox="0 0 24 24" fill="white">
                <path d="M16 17.01V10h-2v7.01h-3L15 21l4-3.99h-3zM9 3L5 6.99h3V14h2V6.99h3L9 3z" />
              </svg>
            </div>
            <h3 class="action-title">Transfer</h3>
            <p class="action-description">Send money to another account</p>
          </div>
        </div>
      </div>

      <div class="transactions-section">
        <div class="section-header">
          <h3 class="section-title">Recent Transactions</h3>
          <span class="view-all" id="viewAllTransactions">View All</span>
        </div>

        <ul class="transaction-list" id="transactionList">
          <!-- Transactions will be rendered here -->
        </ul>
      </div>
    </div>
  </div>

  <div class="footer">
    Â© 2025 Endless Vault. All rights reserved.
  </div>

  <!-- Deposit Modal -->
  <div class="modal" id="depositModal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <div class="modal-header">
        <h3 class="modal-title">
          <svg class="icon" viewBox="0 0 24 24" fill="#2ecc71">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
          </svg>
          Deposit Funds
        </h3>
      </div>
      <div class="form-group">
        <label for="depositAmount">Amount (R)</label>
        <input type="number" id="depositAmount" placeholder="Enter amount to deposit" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label for="depositSource">Source of Funds</label>
        <select id="depositSource" class="amount-input">
          <option value="bank_transfer">Bank Transfer</option>
          <option value="credit_card">Credit Card</option>
          <option value="cash">Cash Deposit</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" id="cancelDeposit">Cancel</button>
        <button class="btn btn-deposit" id="confirmDeposit">
          <svg class="icon" viewBox="0 0 24 24" fill="white">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" />
          </svg>
          Confirm Deposit
        </button>
      </div>
    </div>
  </div>

  <!-- Withdraw Modal -->
  <div class="modal" id="withdrawModal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <div class="modal-header">
        <h3 class="modal-title">
          <svg class="icon" viewBox="0 0 24 24" fill="#e74c3c">
            <path d="M19 13H5v-2h14v2z" />
          </svg>
          Withdraw Funds
        </h3>
      </div>
      <div class="form-group">
        <label for="withdrawAmount">Amount (R)</label>
        <input type="number" id="withdrawAmount" placeholder="Enter amount to withdraw" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label for="withdrawMethod">Withdrawal Method</label>
        <select id="withdrawMethod" class="amount-input">
          <option value="atm">ATM Withdrawal</option>
          <option value="bank_transfer">Bank Transfer</option>
          <option value="branch">Branch Withdrawal</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" id="cancelWithdraw">Cancel</button>
        <button class="btn btn-withdraw" id="confirmWithdraw">
          <svg class="icon" viewBox="0 0 24 24" fill="white">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" />
          </svg>
          Confirm Withdrawal
        </button>
      </div>
    </div>
  </div>

  <!-- Create Account Modal -->
  <div class="modal" id="createAccountModal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <div class="modal-header">
        <h3 class="modal-title">
          <svg class="icon" viewBox="0 0 24 24" fill="#9b59b6">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z" />
          </svg>
          Create New Account
        </h3>
      </div>
      <div class="form-group">
        <label for="accountType">Account Type</label>
        <select id="accountType" class="amount-input">
          <option value="savings">Savings Account</option>
          <option value="checking">Checking Account</option>
          <option value="investment">Investment Account</option>
          <option value="business">Business Account</option>
        </select>
      </div>
      <div class="form-group">
        <label for="initialDeposit">Initial Deposit (R)</label>
        <input type="number" id="initialDeposit" placeholder="Enter initial deposit amount" min="0" step="0.01">
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" id="cancelCreate">Cancel</button>
        <button class="btn btn-create" id="confirmCreate">
          <svg class="icon" viewBox="0 0 24 24" fill="white">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" />
          </svg>
          Create Account
        </button>
      </div>
    </div>
  </div>

  <!-- Transfer Modal -->
  <div class="modal" id="transferModal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <div class="modal-header">
        <h3 class="modal-title">
          <svg class="icon" viewBox="0 0 24 24" fill="#f39c12">
            <path d="M16 17.01V10h-2v7.01h-3L15 21l4-3.99h-3zM9 3L5 6.99h3V14h2V6.99h3L9 3z" />
          </svg>
          Transfer Funds
        </h3>
      </div>
      <div class="form-group">
        <label for="transferAmount">Amount (R)</label>
        <input type="number" id="transferAmount" placeholder="Enter amount to transfer" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label for="recipientAccount">Recipient Account Number</label>
        <input type="text" id="recipientAccount" placeholder="Enter recipient account number">
      </div>
      <div class="form-group">
        <label for="transferReference">Reference</label>
        <input type="text" id="transferReference" placeholder="Enter reference (optional)">
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" id="cancelTransfer">Cancel</button>
        <button class="btn btn-transfer" id="confirmTransfer">
          <svg class="icon" viewBox="0 0 24 24" fill="white">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" />
          </svg>
          Confirm Transfer
        </button>
      </div>
    </div>
  </div>

  <!-- Transaction History Modal -->
  <div class="modal" id="historyModal">
    <div class="modal-content" style="max-width: 700px;">
      <button class="close-modal">&times;</button>
      <div class="modal-header">
        <h3 class="modal-title">
          <svg class="icon" viewBox="0 0 24 24" fill="#3498db">
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" />
          </svg>
          Transaction History
        </h3>
      </div>
      <div style="max-height: 500px; overflow-y: auto;">
        <ul class="transaction-list" id="fullTransactionList">
          <!-- Full transaction history will be rendered here -->
        </ul>
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" id="closeHistory">Close</button>
      </div>
    </div>
  </div>

  <script>
    // --- DOM ELEMENTS ---
    const depositBtn = document.getElementById('depositBtn');
    const withdrawBtn = document.getElementById('withdrawBtn');
    const createAccountBtn = document.getElementById('createAccountBtn');
    const transferBtn = document.getElementById('transferBtn');
    const viewAllTransactions = document.getElementById('viewAllTransactions');

    const depositModal = document.getElementById('depositModal');
    const withdrawModal = document.getElementById('withdrawModal');
    const createAccountModal = document.getElementById('createAccountModal');
    const transferModal = document.getElementById('transferModal');
    const historyModal = document.getElementById('historyModal');

    const cancelDeposit = document.getElementById('cancelDeposit');
    const cancelWithdraw = document.getElementById('cancelWithdraw');
    const cancelCreate = document.getElementById('cancelCreate');
    const cancelTransfer = document.getElementById('cancelTransfer');
    const closeHistory = document.getElementById('closeHistory');

    const confirmDeposit = document.getElementById('confirmDeposit');
    const confirmWithdraw = document.getElementById('confirmWithdraw');
    const confirmCreate = document.getElementById('confirmCreate');
    const confirmTransfer = document.getElementById('confirmTransfer');

    const closeModalButtons = document.querySelectorAll('.close-modal');
    const balanceAmount = document.getElementById('balanceAmount');
    const transactionList = document.getElementById('transactionList');
    const fullTransactionList = document.getElementById('fullTransactionList');

    const logoutBtn = document.getElementById("logoutBtn");

    // --- INITIAL STATE VARIABLES ---
    let currentBalance = 0;
    let transactions = [];

    // --- UTILITY FUNCTIONS ---
    function showModal(modal) {
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function hideModal(modal) {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function updateBalance() {
      balanceAmount.textContent = `R${currentBalance.toFixed(2)}`;
    }

    function formatDate(date) {
      const options = {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
      };
      return date.toLocaleDateString('en-US', options);
    }

    // Renders transactions to a target element. Optionally, limit the number of items.
    function renderTransactions(transactionsArray, targetElement, limit = null) {
      targetElement.innerHTML = '';
      const transactionsToRender = limit ? transactionsArray.slice(0, limit) : [...transactionsArray];
      transactionsToRender.forEach(tx => {
        const txItem = document.createElement('li');
        txItem.className = 'transaction-item';
        // Determine CSS class and sign based on type.
        const amountClass = (tx.type === 'deposit') ? 'positive' : 'negative';
        const amountSign = (tx.type === 'deposit') ? '+' : '-';
        txItem.innerHTML = `
          <div class="transaction-details">
            <div class="transaction-name">${tx.description}</div>
            <span class="transaction-category">${tx.transactionType}</span>
            <div class="transaction-date">${formatDate(new Date(tx.transactionDate))}</div>
          </div>
          <div class="transaction-amount ${amountClass}">${amountSign}R${Number(tx.amount).toFixed(2)}</div>
        `;
        targetElement.appendChild(txItem);
      });
    }

    // --- EVENT HANDLERS & INITIALIZATION ---
    // Logout handler (assumed working) 
        logoutBtn.addEventListener("click", async () => {
            try {
                const response = await fetch("/auth/logout", {
                    method: "POST"
                });
                if (response.ok) {
                    window.location.href = "/login.html";
                } else {
                    alert("Logout failed");
                }
            } catch (e) {
                console.error("Logout error", e);
            }
        });
 
        window.addEventListener("DOMContentLoaded", () => {
            fetch("/user/info")
            .then(response => {
                if (!response.ok) {
                window.location.href = "/login.html";
                }
                return response.json();
            })
            .then(data => {
                document.getElementById("userName").textContent = `${data.name} ${data.surname}`;
            })
            .catch(error => {
                console.error("Error fetching user info:", error);
            });
        });

    // On page load, fetch dashboard data (balance & transactions)
    document.addEventListener('DOMContentLoaded', () => {
      fetch("/api/dashboard")
        .then(response => response.json())
        .then(data => {
          currentBalance = data.balance;
          updateBalance();
          // Assume that the backend returns transactions with keys:
          // id, amount, transactionType, description, transactionDate
          transactions = data.transactions;
          renderTransactions(transactions, transactionList, 5);
          renderTransactions(transactions, fullTransactionList);
        })
        .catch(error => {
          console.error("Error fetching dashboard data", error);
        });

      // Profile dropdown toggle
      const profileSection = document.getElementById('profileSection');
      const profileDropdown = document.getElementById('profileDropdown');
      profileSection.addEventListener('click', function (e) {
        e.stopPropagation();
        profileDropdown.classList.toggle('show');
      });
      document.addEventListener('click', function () {
        profileDropdown.classList.remove('show');
      });

      // Modal open event listeners
      depositBtn.addEventListener('click', () => showModal(depositModal));
      withdrawBtn.addEventListener('click', () => showModal(withdrawModal));
      createAccountBtn.addEventListener('click', () => showModal(createAccountModal));
      transferBtn.addEventListener('click', () => showModal(transferModal));
      viewAllTransactions.addEventListener('click', () => showModal(historyModal));

      // Modal cancel/close event listeners
      cancelDeposit.addEventListener('click', () => hideModal(depositModal));
      cancelWithdraw.addEventListener('click', () => hideModal(withdrawModal));
      cancelCreate.addEventListener('click', () => hideModal(createAccountModal));
      cancelTransfer.addEventListener('click', () => hideModal(transferModal));
      closeHistory.addEventListener('click', () => hideModal(historyModal));
      closeModalButtons.forEach(button => {
        button.addEventListener('click', function () {
          hideModal(this.closest('.modal'));
        });
      });

      // --- API CALLS ON MODAL CONFIRMATION ---
      // Confirm deposit
      confirmDeposit.addEventListener('click', function () {
        const amount = parseFloat(document.getElementById('depositAmount').value);
        if (amount && amount > 0) {
          fetch("/api/deposit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount: amount })
          })
            .then(response => {
              if (!response.ok) {
                throw new Error("Deposit failed");
              }
              return response.json();
            })
            .then(data => {
              currentBalance = data.balance;
              updateBalance();
              hideModal(depositModal);
              document.getElementById('depositAmount').value = '';
              alert(`Successfully deposited R${amount.toFixed(2)}`);
              // Optionally, refresh transaction list here (by re-fetching /api/dashboard)
            })
            .catch(err => {
              alert(err.message);
            });
        } else {
          alert("Please enter a valid positive amount");
        }
      });

      // Confirm withdraw
      confirmWithdraw.addEventListener('click', function () {
        const amount = parseFloat(document.getElementById('withdrawAmount').value);
        if (amount && amount > 0) {
          if (amount > currentBalance) {
            alert("Insufficient funds for this withdrawal");
            return;
          }
          fetch("/api/withdraw", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount: amount })
          })
            .then(response => {
              if (!response.ok) {
                throw new Error("Withdrawal failed");
              }
              return response.json();
            })
            .then(data => {
              currentBalance = data.balance;
              updateBalance();
              hideModal(withdrawModal);
              document.getElementById('withdrawAmount').value = '';
              alert(`Successfully withdrew R${amount.toFixed(2)}`);
            })
            .catch(err => {
              alert(err.message);
            });
        } else {
          alert("Please enter a valid positive amount");
        }
      });

      // Confirm transfer
      confirmTransfer.addEventListener('click', function () {
        const amount = parseFloat(document.getElementById('transferAmount').value);
        const recipient = document.getElementById('recipientAccount').value;
        if (amount && amount > 0) {
          if (amount > currentBalance) {
            alert("Insufficient funds for this transfer");
            return;
          }
          if (!recipient) {
            alert("Please enter recipient account number");
            return;
          }
          fetch("/api/transfer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount: amount, recipientAccount: recipient })
          })
            .then(response => {
              if (!response.ok) {
                throw new Error("Transfer failed");
              }
              return response.json();
            })
            .then(data => {
              currentBalance = data.balance;
              updateBalance();
              hideModal(transferModal);
              document.getElementById('transferAmount').value = '';
              document.getElementById('recipientAccount').value = '';
              alert(`Successfully transferred R${amount.toFixed(2)} to account ${recipient}`);
            })
            .catch(err => {
              alert(err.message);
            });
        } else {
          alert("Please enter a valid positive amount");
        }
      });

      // Confirm create account
      confirmCreate.addEventListener('click', function () {
        const accountType = document.getElementById('accountType').value;
        const initialDeposit = parseFloat(document.getElementById('initialDeposit').value) || 0;
        fetch("/api/create-account", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ accountType: accountType, initialDeposit: initialDeposit })
        })
          .then(response => {
            if (!response.ok) {
              throw new Error("Account creation failed");
            }
            return response.json();
          })
          .then(data => {
            hideModal(createAccountModal);
            document.getElementById('initialDeposit').value = '';
            alert(`New ${accountType} account created successfully!`);
            // You could optionally refresh the dashboard data here.
          })
          .catch(err => {
            alert(err.message);
          });
      });

      // Close modal if clicking outside content
      window.addEventListener('click', function (event) {
        if (event.target.classList.contains('modal')) {
          hideModal(event.target);
        }
      });
    });
  </script>
</body>

</html>